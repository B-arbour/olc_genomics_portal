{% extends "base.html" %}
{#Head container#}
{% load staticfiles %}
{% load bootstrap %}
{% load i18n widget_tweaks %}
{% block content %}
<br>
  <a href="{% url 'geneseekr:geneseekr_query' %}" class="btn btn-primary btn-block" role="button" aria-pressed="true"><i class="fas fa-plus"></i> Create A GeneSeekr Query</a>
  <br>
  <h2>GeneSeekr Home</h2>
  <br>
  <table id="geneseekr-request-table" class="table table-hover">
    <thead>
    <tr>
       <th>SEQIDs</th>
       <th>Status</th>
       <th>Download</th>
       <th>Request Date</th>
       <th>       </th>
       <th>Name</th>
       {#       <th>Type</th>#}
    </tr>
  </thead>

  <tbody>
     {% for geneseekr_request in geneseekr_requests %}
     <tr>
       <td>
          {% for seqid in geneseekr_request.seqids|slice:":3" %}
            <p style="font-size:14px">{{ seqid }}</p>
          {% endfor %}
         {% if geneseekr_request.seqids|length > 3 %}
           <p style="font-size:14px">...and {{ geneseekr_request.seqids|length|add:'-3' }} more</p>
         {% endif %}
       </td>
          {% if geneseekr_request.status == 'Complete' %}
             <td><a href="{% url 'geneseekr:geneseekr_processing' geneseekr_request_pk=geneseekr_request.pk %}" class="btn btn-success" role="button">{{ geneseekr_request.status }} <i class="fas fa-check-circle"></i></a></td>
          {% elif geneseekr_request.status == 'Processing' %}
             <td><a href="{% url 'geneseekr:geneseekr_processing'  geneseekr_request_pk=geneseekr_request.pk %}" class="btn progress-bar progress-bar-striped progress-bar-animated bg-info" role="button">{{ geneseekr_request.status }}</a></td>
          {% elif geneseekr_request.status == 'Error' %}
             <td><a href="{% url 'geneseekr:geneseekr_processing'  geneseekr_request_pk=geneseekr_request.pk %}" class="btn btn-danger" role="button">{{ geneseekr_request.status }}</a></td>
          {% elif geneseekr_request.status == 'Unprocessed' %}
             <td><a href="{% url 'geneseekr:geneseekr_processing'  geneseekr_request_pk=geneseekr_request.pk %}" class="btn btn-secondary" role="button">{{ geneseekr_request.status }}</a></td>
          {% endif %}

          {% if geneseekr_request.status == 'Complete' %}
            <td><a href="{{ geneseekr_request.download_link }}" class="btn btn-outline-dark" role="button">Download <i class="fas fa-download"></i></a></td>
          {% else %}
            <td><button class="btn-dark" disabled>Not Available</button></td>
          {% endif %}

        <td>{{ geneseekr_request.created_at }}</td>
{#        {% if geneseekr_request.request_type == 'BLASTN' %}#}
{#          <td><button class="btn btn-secondary" disabled>BLASTN</button></td>#}
{#          TODO: Add other geneseekr blast options once they're implemented.#}
{#        {% else %}#}
{#          <td><button class="btn btn-dark" disabled>Other</button></td>#}
{#        {% endif %}#}
        <form method="post">
        {% csrf_token %}
        {% if geneseekr_request.status != 'Processing' and 'Unprocessed' %}
          <td><button class="btn btn-danger" type="submit" id="btn-submit" name="delete" value={{geneseekr_request.pk}}> Delete  <i class="fas fa-trash-alt"></i></button></td>
        {% else %}
          <td></td>
        {% endif %}
        <td><a href="{% url 'geneseekr:geneseekr_name'  geneseekr_request_pk=geneseekr_request.pk %}">{{geneseekr_request.name}} <i class="fas fa-pen" aria-hidden="true"></i></a></td>
        </form>
     </tr>
     {% endfor %}
  </tbody>
  </table>

  <script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
  <script src="{% static 'js/datatables.min.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static '/css/datatables.min.css' %}"/>
  <script type="text/javascript">
    $(document).ready(function () {
        $('#geneseekr-request-table').dataTable()
    });
    setInterval(function () {
      {% for geneseekr_request in geneseekr_requests %}
        {% if geneseekr_request.status == 'Processing' %}
          window.location = window.location.href;
        {% endif %}
      {% endfor %}
    }, 60000) // This should refresh the page every 60 seconds as long as run status is processing

$("#btn-submit").click(function(e) {
  e.preventDefault();
  var csrftoken = Cookies.get('csrftoken');
    swal({
    title: "Are you sure?",
    icon: "warning",
    buttons: { cancel: "Cancel", confirm: "Delete"},
    dangerMode: true
    })
    .then((willDelete) => {
    if (willDelete) {
        $.ajax({
          type:"POST",
          data: {csrfmiddlewaretoken:csrftoken,"delete":this.value},
          success: function(data) {
            swal({
            button: false,
            title:"Deleted!", 
            text:"Data successfully Deleted!", 
            icon:"success",
            timer:3000})
            .then((value) =>{
            if (value == null)
            {
              location.reload();
            }
          })
          }
        })}
     else {
      swal({
            button: false,
            text:"Delete Cancelled",
             icon: "error"})
      .then((value) =>{
            if (value == null)
            {
              location.reload();
            }
          });
    }
});
});
  </script>
{% endblock %}